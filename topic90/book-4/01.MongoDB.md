
## MongoDB Server deployment.

We must create a persistent volume and a persistent volume claim before deploying the database server. In `multi-component-app`, create the file `pvc.yaml`:
~~~
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mongo-pvc-sc
spec:
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 50M
  storageClassName: "nfs-client"
~~~
This claim is for 50 megabytes of storage on the networked file system linked to the cluster (storageClassName: "nfs-client"). Request the cluster to create this resource:
~~~
❯ oc apply  -f pvc.yaml 
❯ oc get pvc    (pvc - persistentvolumeclaims)                       
~~~
The apply command creates the persistent volume as well as the persistent volume claim. Notice in the response to the get command above, under the Volume column is the name of the persistent volume. Try getting it:
~~~
e.g.
$ oc get pv  pvc-9e23ee3e-e18a-47e2-8c52-9566f94d3225                   
~~~
You do not have permission to run this command.

Commit this work:
~~~
$ git add -A
$ git commit -m "Creating PVC for database."
~~~

### Deployment resource.

We can now create a database server pod. Add a deployment manifest to `multi-component-app` folder, called `mongo-deployment.yaml`:
~~~
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mongo-depl
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mongo-pod
  template:
    metadata:
      labels:
        app: mongo-pod
    spec:
      serviceAccountName: bsc-ssd-y4-2025-sa
      containers:
      - image: bitnami/mongodb:latest
        name: mongo
        env:
        - name: MONGODB_ROOT_PASSWORD
          value: "secret"
        - name: MONGODB_ROOT_USER
          value: "admin"
        ports:
        - containerPort: 27017
        volumeMounts:
        - mountPath: /bitnami/mongodb 
          name: mongo-volume
      volumes:
      - name: mongo-volume
        persistentVolumeClaim:
          claimName: mongo-pvc-sc
~~~ 
The [bitnami/mongodb][bitnami] Docker Hub image is recommended by Red Hat for their OpenShift platform. Its default path for the databases managed by this server is '/bitnami/mongodb' (as opposed to /data/db). We mount the persistent volume to this path using the persistent volume claim. Referencing our custom serviceaccount in the manifest grants permission to the pod to request the pulling of this image. Create the deployment resource in the cluster (and by implication the pod):
~~~
$ oc apply  -f mongo-deploy.yaml   
$ oc get deploy   
$ oc get rs 
$ oc get po 
~~~
Assuming the pod is running, try connecting to it (use your pod name):
~~~
$ oc exec -it mongo-pod-6ccf877dc5-jdh7b  -- /bin/sh
# ls /bitnami/mongodb
data
# exit
~~~ 

Commit this work:
~~~
$ git add -A
$ git commit -m "Creating Deployment resource for database server."
~~~

### Service.

Next, create a service resource for the pod. Create the file `mongo-service.yaml`:
~~~
apiVersion: v1
kind: Service
metadata:
  name: mongo-svc
spec:
  ports:
  - port: 27017
    protocol: TCP
    targetPort: 27017
  selector:
    app: mongo-pod
~~~
Apply the manifest:
~~~
❯ oc apply  -f mongo-service.yaml 
❯ oc get svc                  
~~~

To verify that the database server is functioning, we'll connect to it using our laptop's MongoDB Compass client (which we used earlier in the semester). Link the laptop's port 27017 to the same port on the Mongo service (the service will automatically forward any requests to the pod):
~~~
$ oc port-forward service/mongo-svc 27017:27017
~~~
Start the MongoDB Compass client, and create a new Connection with these attributes:

+ URL = mongodb://admin:secret@localhost:27017/    (The protocol is mongoDB because we are communicating with the database server. In the deployment YAML above, we set the root user's credentials to admin (userbane) and secret (password). The domain name is localhost because we are communicating to the Mongo server through the host computer.)
+ Name = K8s Mongo Server (arbitrary)

Click Save & Connect. On the left-hand panel, you should see the current list of databases managed by the Mongo server inside the pod, namely:

+ admin
+ config
+ local

Add a new database to the list by clicking the plus (+) to the right of the connection name on the left-hand panel, and enter the following details:

+ Database name = tmdb.
+ Collection name = movies

Click Create Database.

To seed the collection:

1. Download and unzip [this][seed] JSON file. 
1. In Compass, select the movies collection in the left panel, and click the Import data button on the right.
1. Find the `movies.json` file you downloaded and click Import.

In the next section, we will access the database from a pod inside the cluster.

In VS Code, stop the port-forwarding to the MongoDB service.

Commit this work:
~~~
$ git add -A
$ git commit -m "Creating  Service resource for database server."
~~~


[bitnami]: https://hub.docker.com/r/bitnami/mongodb
[seed]: ./img/seed.zip