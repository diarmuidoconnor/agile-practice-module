## Mongo Express web App Component.

The second component of our application is the Web app. It needs a deployment (to create a pod(s)) and a service. We can have more than one manifest in a single YAML file by separating them with triple-dash (---). Create the file `deploy-express.yaml`:
~~~
apiVersion: apps/v1
kind: Deployment
metadata:
  name: express-depl
spec:
  replicas: 2
  selector:
    matchLabels:
      app: express-pod
  template:
    metadata:
      labels:
        app: express-pod
    spec:
      serviceAccountName: bsc-ssd-y4-2025-sa
      containers:
      - image: mongo-express
        name: express
        env:
        - name: ME_CONFIG_MONGODB_ADMINUSERNAME
          value: "admin"
        - name: ME_CONFIG_MONGODB_ADMINPASSWORD
          value: "secret"
        - name: ME_CONFIG_MONGODB_SERVER
          value: "mongo-svc"
---

apiVersion: v1
kind: Service
metadata:
  name: express-svc
spec:
  ports:
  - port: 8081
    protocol: TCP
    targetPort: 8081
  selector:
    app: express-pod
~~~
Apply the file as before:
~~~
$ oc apply  -f deploy-express.yaml
~~~
As expected, many resources are created: a deployment, a replicaset, two pods, and a service (two pod replicas of the web app were made, for illustration):
~~~
$ oc get deploy                    
$ oc get rs                    
$ oc get svc
$ oc get po 
~~~
Returning to the YAML file above, in the Deployment manifest, we use the Mongo Express Docker image, which we used in an earlier Docker lab. The image contains a Node-Express web app that listens on port 8081, and it expects three environment variables, namely:
+ ME_CONFIG_MONGODB_SERVER - this must be set to the domain name of the database server, which, in a Kubernetes cluster, is the name of the service whose endpoint (pod) running the MongoDB container - mongo-svc. 
+ ME_CONFIG_MONGODB_ADMINUSERNAME - the database root user's username.
+ ME_CONFIG_MONGODB_ADMINPASSWORD - the database root user's password.

These three variables allow the web app to construct the full connection string for the database server: 
>mongodb://admin:secret@mongo-svc:27017/

Check the logs of any one of the web app pods to confirm it connects successfully to the database:
~~~
$ oc logs express-depl-798df47f44-9s5zp         (Use your pod name)       
~~~
The end of the response should look as follows:
~~~
Welcome to mongo-express 1.0.2
------------------------


Mongo Express server listening at http://0.0.0.0:8081
Server is open to allow connections from anyone (0.0.0.0)
basicAuth credentials are "admin:pass", it is recommended you change this in your config.js!
~~~

Use port-forwarding to see the web app in a browser:
~~~
$ oc port-forward service/express-svc  3000:8081
~~~
Here, we are connecting your host's port 3000 to port 8081 of the cluster service. The service forwards requests to one of the web app pods. Open a browser tab at http://localhost:3000/. You should see the list of databases being managed by the MongoDB server, in particular, the TMDB database. 

 Commit this work:
~~~
$ git add -A
$ git commit -m "Creating cluster resources for web app."
~~~

### Review

You have now deployed the architecture below. 

![][arch]

Make sure you fully understand the resources you created in the cluster:
+ Pods
+ Deployments
+ Replica sets
+ Services
+ Persistent Volume claims
+ Persistent Volume

[arch]: ./img/arch.png
