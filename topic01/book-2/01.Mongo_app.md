## Demo App Setup.

From the command line, type the following command:
~~~bash
$ docker pull mongo:8.0-rc     (This image containing the MongoDB database server)
$ docker pull mongo-express:1.0-20-alpine3.19    (A web-based MongoDB admin application)
$ docker network create mongo-network
~~~
The last command creates a virtual network named mongo-network (the network's name is arbitrary). To confirm the creation, type the command:
~~~bash
$ docker network ls
~~~
As well as our new network, Docker creates some default networks at start-up, e.g. bridge and host. Docker virtual networks have a driver (or type). The default type is bridge,  while other options include overlay, host, macvlan, etc. A container can be attached to multiple networks simultaneously. By default, every container is attached to the network named bridge - its type is bridge. A bridge (type) network is assigned a IP address subnet range and has a gateway to the internet. Each container added to a bridge network is assigned an IP address from the subnet range - this is performed by a DHCP server provided by Docker. 

Type the command:
~~~bash
$ docker network inspect mongo-network
~~~
Notice the config section of the JSON response:
~~~json
// 
Sample response
    "Config": [
        {
            "Subnet": "172.17.0.0/16",
            "Gateway": "172.17.0.1"
        }
    ]
~~~
Use the same command for the default bridge network interface (docker network inspect bridge).

Start a container for the MongoDB image:
~~~bash
$ docker run -d --net mongo-network \
    --name my-mongoDB  \
    -p 27017:27017 \
    -e MONGO_INITDB_ROOT_USERNAME=admin \
    -e MONGO_INITDB_ROOT_PASSWORD=secret \
 mongo:8.0-rc
~~~
Points to note in this command:
1. Environment variables - Use the -e option to initializa a container's environment variables. The variable names are documented in an imagre's specification on Docker Hub. For example, go to [this page][mongov] and scroll to the Environment Variables section for details on the MongoDB image. Some image's environment variables are optional and have default values.
1. We attached the MongoDB container to the mongo-network virtual network. Docker creates a virtual ethernet interface for the container and links it to the network's virtual bridge/switch. Only containers attached to this network can communicate with the Mongo container - see later.
1. Port 27017 is the default MongoDB port for client communication. Using Docker's port forwarding facility, we are mapping the container's port 27017 to the host computer's port 27017. This will allow non-containerized applications to interact with the database - see later.

Type the following command:
~~~bash
$ docker run -d --network mongo-network \
      --name mongo-express  \
      -p 8081:8081 \
      -e ME_CONFIG_MONGODB_ADMINUSERNAME=admin \
      -e ME_CONFIG_MONGODB_ADMINPASSWORD=secret \
      -e ME_CONFIG_MONGODB_SERVER=my-mongoDB   \
    mongo-express:1.0-20-alpine3.19
~~~

Points to note in this command:

1. This container uses the same virtual network because it needs to connect to the MongoDB server.
1. The ME_CONFIG_MONGODB_SERVER environment variable must be set to the __name of the container__ running the database server, i.e. my-mongoDB. Custom Docker bridge (type) networks (e.g. mongo-network) support __DNS name resolution__ - it resolves container names to their IP addresses. 
1. The ME_CONFIG_MONGODB_ADMINUSERNAME and ME_CONFIG_MONGODB_ADMINPASSWORD variables must match the credentials used by the MongoDB container. 
1. The three environment variables allowa the web app to construct the MongoDB server URL connection string - mongodb://admin:secret@my-mongoDB:27017/. The general form of this string is mongodb://username:password@serverDomainName:port/.
1. The mongo-express web application listens for HTTP requests on port 8081. We map this to the equivilant port on the host computer to allows an external web browser client access the app.

To view the Mongo-Express admin web application hosted by the second container, open a new browser tab at http://localhost:8081/. Login with the credentials *admin* for username and *pass* for password - these are the default credentials of the web app, not the DB server admin credentials. The browser lists the databases managed by the MongoDB server running inside the first container. 

![][express]

Let's add a new database to the server using the web admin tool. In the browser, locate the text box at the top-right, enter the name `tmdb` (The Movies Database) and click the Create Database button. Click the View button for this database, and add a new collection (top right of the page) named `movies`. Click the 'movies' collection, click the 'New Document' button, and add this JSON document:
~~~json


  {
    "_id": ObjectId(),
    "original_language": "en",
    "overview": "When a peaceful colony on the edge of the galaxy finds itself threatened by the armies of the tyrannical Regent Balisarius, they dispatch Kora, a young woman with a mysterious past, to seek out warriors from neighboring planets to help them take a stand.",
    "popularity": 2136.3,
    "release_date": "2023-12-15",
    "title": "Rebel Moon - Part One: A Child of Fire"
  }
~~~
Repeat these steps to add two more documents:
~~~json
{     
    "_id": ObjectId(),
    "original_language": "en",
    "overview": "Black Manta, still driven by the need to avenge his father's death and wielding the power of the mythic Black Trident, will stop at nothing to take Aquaman down once and for all. To defeat him, Aquaman must turn to his imprisoned brother Orm, the former King of Atlantis, to forge an unlikely alliance in order to save the world from irreversible destruction.",
    "popularity": 1605.303,
    "release_date": "2023-12-20",
    "title": "Aquaman and the Lost Kingdom"
}
~~~
~~~json
{     
    "_id": ObjectId(),
    "original_language": "en",
    "overview": "64 years before he becomes the tyrannical president of Panem, Coriolanus Snow sees a chance for a change in fortunes when he mentors Lucy Gray Baird, the female tribute from District 12.",
    "popularity": 1509.974,
    "release_date": "2023-11-15",
    "title": "The Hunger Games: The Ballad of Songbirds & Snakes"
}
~~~

------------------------------------

Before continuing with multi-container applications, lets look at some basic Docker networking. We will cover the topic in more detail in a later lab.

Examine the status of the mongo-network network by typing the command:
~~~bash
$ docker network inspect mongo-network
~~~
Notice the containers section of the JSON response:
~~~json
       "Containers": {
            "4421b2d2f2f1ae8f7bbad777f308a5c2b718a59db06531488d567083004a5ea5": {
                "Name": "mongo-express",
                "EndpointID": "6833c54b563974cf32f62f4308bac6d500ac40078cd4425384a3b5834a8c8d86",
                "MacAddress": "02:42:ac:12:00:03",
                "IPv4Address": "172.18.0.3/16",
                "IPv6Address": ""
            },
            "5010babf9a8dbdc28592a16e270acd6858347ce9f096009b5a30edae87bbc8a4": {
                "Name": "mongoDB",
                "EndpointID": "6bbd0907ca24aab5be8bbc93559782d35c04ae5566155d0116e4edd569061cd6",
                "MacAddress": "02:42:ac:12:00:02",
                "IPv4Address": "172.18.0.2/16",
                "IPv6Address": ""
            }
        },
~~~
It shows the IP address assigned to each container by Docker's DHCP server. The MacAddress property corresponds to the container's virtual ethernet interface. Confirm the IP addresses with the command:
~~~bash
$ docker inspect my-mongoDB
~~~
Notice the Networks section of the response:
~~~json
    "Networks": {
        "mongo-network": {
            "IPAMConfig": null,
            "Links": null,
            "Aliases": [
                "5010babf9a8d"
            ],
            "NetworkID": "b2743273da17e22e0137e94ca2571f9fcc11a61ed433a1714c734071fbe585d7",
            "EndpointID": "6bbd0907ca24aab5be8bbc93559782d35c04ae5566155d0116e4edd569061cd6",
            "Gateway": "172.18.0.1",
            "IPAddress": "172.18.0.2",
            "IPPrefixLen": 16,
            "IPv6Gateway": "",
            "GlobalIPv6Address": "",
            "GlobalIPv6PrefixLen": 0,
            "MacAddress": "02:42:ac:12:00:02",
            "DriverOpts": null
        }
    }
~~~
More on Docker networking in a later lab. 

------------------------------------------

### Accessing Containers Externally.

Managing a containerized database server using an external tool may be desirable in certain cases. For our demo, we can use the MongoDB Compass tool to access the database server running inside the container. Use [this link][compassd] to download and install Compass. 

Start the tool. Click the 'Add new connection' button, and create a new connection with the following properties:

+ Name - MongoDB container
+ URL - mongodb://admin:secret@localhost:27017/

Click the 'Save & Connect' button. On the left hand panel, the databases managed by the MongoDB container are listed, including the tmdb database. Expand it to see the movies collection and its documents. 

![][compass]

We successfully connected to the containerized MongoDB server from an external application (Compass). This worked for the following reasons:

1. The host's port 27017 is mapped to the container's port 27017, and the DB server is listening on port 27017.
1. The URL connection string used by the Compass tool follows the required format: mongodb://ADMIN_USERNAME:PASSWORD@DBSERVER_DOMAINNAME:PORT, i.e. mongodb://admin:secret@localhost:27017/. The domain name is localhost as we are connecting from the host's port 27017.

Overall, there are two communication flows working in this case study:

1. MongoDB Compass to MongoDB container - This is over the regular localhost network managed by the host computer. 
1. Mongo Express container to MongoDB container - This is via the Docker-managed network we created - the bridge network named mongo-network. The connection string used by the Express app is mongodb://admin:secret@my-mongoDB:27017/.


[compass]: ./img/compass.png
[express]: ./img/express.png
[mongov]: https://hub.docker.com/_/mongo
[compassd]: https://www.mongodb.com/docs/compass/install/?operating-system=linux&package-type=.deb