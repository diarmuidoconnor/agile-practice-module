
## MongoDB Server deployment.

We must create a persistent volume and a persistent volume claim before deploying the database server. In `multi-component-app`, create the file `pvc.yaml`:
~~~
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
 name: mongo-pvc-sc
spec:
 accessModes:
 - ReadWriteMany
 resources:
 requests:
 storage: 50M
 storageClassName: "nfs-client"
~~~
This claim is for 50 megabytes of storage on the networked file system linked to the cluster (storageClassName: "nfs-client"). Request the cluster to create this resource:
~~~
❯ oc apply  -f pvc.yaml -n [your-namespace]
❯ oc get persistentvolumeclaims -n [your-namespace]                         
~~~
The apply command creates the persistent volume as well as the persistent volume claim. Notice in the response to the get command above, under the Volume column is the name of the volume. Volumes are not namespac-scoped.  To list all the volumes currently managed by the cluster:
~~~
$ oc get persistentvolumes                   
~~~
Look under the Claim column for your namespace name.

Commit this work:
~~~
$ git add -A
$ git commit -m "Creating PVC  for database."
~~~

### Deployment resource.

We can now create a database server pod. Add a deployment manifest for the database server to the `multi-component-app` folder, called `mongo-deployment.yaml`:
~~~
apiVersion: apps/v1
kind: Deployment
metadata:
 name: mongo
spec:
 replicas: 1
 selector:
 matchLabels:
 app: mongo
 template:
 metadata:
 labels:
 app: mongo
 spec:
 serviceAccountName: mongodb-sa
 containers:
 - image: bitnami/mongodb:latest
 name: mongo
 env:
 - name: MONGODB_ROOT_PASSWORD
 value: "secret"
 - name: MONGODB_ROOT_USER
 value: "admin"
 ports:
 - containerPort: 27017
 volumeMounts:
 - mountPath: /bitnami/mongodb 
 name: mongo-volume
 volumes:
 - name: mongo-volume
 persistentVolumeClaim:
 claimName: mongo-pvc-sc
~~~ 
The [bitnami/mongodb][bitnami] Docker Hub image is recommended by Red Hat for their OpenShift platform. Its default path for the databases being managed is '/bitnami/mongodb'. We mount the persistent volume to this path using the persistent volume claim. Referencing our custom serviceaccount in the manifest grants permission to the pod to request the pulling of this image. Create the deployment resource in the cluster (and by implication the pod):
~~~
$ oc apply  -f mongo-deploy.yaml -n  [your-namespace]  
$ oc get deploy -n  [your-namespace]  
$ oc get rs -n  [your-namespace]  
$ oc get pod -n  [your-namespace]  
~~~
Assuming the pod is running, try connecting to it (use your pod name):
~~~
$ oc exec -it mongo-6ccf877dc5-jdh7b -n [your-namespace]  -- /bin/sh
# ls /bitnami/mongodb
data
# exit
~~~ 
 Commit this work:
~~~
$ git add -A
$ git commit -m "Creating Deployment resource for database server."
~~~

### Service.

Next, create a service resource for the pod. Create the file `mongo-service.yaml`:
~~~
apiVersion: v1
kind: Service
metadata:
  name: mongo-svc
spec:
  ports:
 - port: 27017
      protocol: TCP
      targetPort: 27017
  selector:
    app: mongo
~~~
Apply the manifest:
~~~
❯ oc apply  -f mongo-service.yaml -n   [your-namespace]
❯ oc get svc  -n   [your-namespace]                 
~~~

To verify that the database server is functioning, we'll connect to it using our laptop's MongoDB Compass client. Link the laptop's port 27017 to the same port on the Mongo service (the service will automatically forward any requests to the pod):
~~~
$ oc port-forward service/mongo-svc -n doc-trial2 27017:27017:
~~~
Start the MongoDB Compass client, and create a new Connection with the attributes:
+ URL = mongodb://admin:secret@localhost:27017/    (The protocol is mongoDB because we are communicating with the database server. In the deployment YAML above, we set the root user's credentials to admin (userbane) and secret (password). The domain name is localhost because we are communicating through the host.)
+ Name = K8s Mongo Server (arbitrary)

Click Save & Connect. On the left-hand panel, you should see the current list of databases managed by the server, namely:
+ admin
+ config
+ local

Add a new database to the list by clicking the plus (+) to the right of the connection name on the left-hand panel, and enter the following details:

+ Database name: tmdb.
+ Collection name: movies

Click Create Database.
To seed the collection:
Download and unzip [this][seed] JSON file. 
In Compass, select the movies collection in the left panel, and click the Import data button on the right.
Find the `movies.json` file and click Import.

 Commit this work:
~~~
$ git add -A
$ git commit -m "Creating  Service resource for database server."
~~~

[bitnami]: https://hub.docker.com/r/bitnami/mongodb
[seed]: ./img/seed.zip