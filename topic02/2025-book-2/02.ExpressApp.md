## Mongo Express web App Component.

The second component of our application is the Web app. It needs a deployment (to create a pod(s)) and a service. We can have more than one manifest in a single YAML file by separating them with triple-dash (---). Create the file `deploy-express.yaml`:
~~~
apiVersion: apps/v1
kind: Deployment
metadata:
  name: express
spec:
  replicas: 2
  selector:
    matchLabels:
      app: express-pod
  template:
    metadata:
      labels:
        app: express-pod
    spec:
      containers:
 - image: mongo-express
          name: express
          env:
 - name: ME_CONFIG_MONGODB_ADMINUSERNAME
              value: "admin"
 - name: ME_CONFIG_MONGODB_ADMINPASSWORD
              value: "secret"
 - name: ME_CONFIG_MONGODB_SERVER
              value: "mongo-svc.[your-namespace]"
---

apiVersion: v1
kind: Service
metadata:
  name: express-svc
spec:
  ports:
 - port: 8081
      protocol: TCP
      targetPort: 8081
  selector:
    app: express-pod

~~~
[__Note:__ You must use your namespace when setting the value of the ME_CONFIG_MONGODB_SERVER environment variable above.]
 
Apply the file as before:
~~~
$ oc apply  -f deploy-express.yaml -n [your-namespace]
~~~
As expected, two resources are created: a deployment and a service. We now have three pods (two replicas of the web app were made, for illustration) and two services:
~~~
$ oc get po  -n  [your-namespace]                    
$ oc get svc  -n  [your-namespace]                    
~~~
Returning to the YAML file above, in the Deployment manifest, we use the Mongo Express Docker image, which we used in an earlier Docker lab. The image contains a Node-Express web app that listens on port 8081, and it expects three environment variables, namely:
+ ME_CONFIG_MONGODB_SERVER - this must be set to the domain name for the database server, which, in a Kubernetes cluster, is of the form 'database-service-name.namespace'. The service name is our MongoDB service (run oc get svc to check). 
+ ME_CONFIG_MONGODB_ADMINUSERNAME - must match the database root user's username, i.e. admin
+ ME_CONFIG_MONGODB_ADMINPASSWORD -  must match the database root user's password, i.e. secret.

These three variables allow the web app to construct the full connection string for the database server: 
>mongodb://admin:secret@mongo-svc.some-namespace:27017/

Check the logs of any one of the web app pods to confirm it connects successfully to the database:
~~~
$ oc logs express-798df47f44-9s5zp -n [your-namespace]          (Use your pod name)       
~~~
The end of the response should look as follows:
~~~
Welcome to mongo-express 1.0.2
------------------------


Mongo Express server listening at http://0.0.0.0:8081
Server is open to allow connections from anyone (0.0.0.0)
basicAuth credentials are "admin:pass", it is recommended you change this in your config.js!
~~~

Use port-forwarding to see the web app in a browser:
~~~
$ oc port-forward service/express-svc -n [your-namespace]  3000:8081
~~~
Here, we are connecting the host's port 3000 to port 8081 of the service we created above. The service forwards requests to one of the web app pods. Open a browser tab at http://localhost:3000/. You should see the list of databases being managed by the MongoDB server, in particular, the TMDB database. 

 Commit this work:
~~~
$ git add -A
$ git commit -m "Creating cluster resources for web app."
~~~

### Review

You have now deployed the architecture below. 

![][arch]

Make sure you fully understand the resources you created in the cluster:
+ Pods
+ Deployments
+ Replica sets
+ Services
+ Persistent Volume claims
+ Persistent Volume

[arch]: ./img/arch.png
